FROM python:3.8-alpine AS base

ENV PYROOT /pyroot
ENV PYTHONUSERBASE $PYROOT

# Build ContainerARG BUILD_DEPS="gcc python3-dev musl-dev postgresql-dev jpeg-dev zlib-dev libjpeg libffi-dev openjdk8"
RUN apk --no-cache add ${BUILD_DEPS}
RUN pip install --upgrade pip
# RUN pip install celery
RUN pip install pipenv

# Setup JAVA_HOME -- useful for docker commandline
# ENV JAVA_HOME /usr/lib/jvm/java-8-openjdk-amd64/
# RUN export JAVA_HOME

COPY Pipfile* Pipfile.lock* ./
RUN PIP_USER=1 PIP_IGNORE_INSTALLED=1 pipenv install --system --deploy --ignore-pipfile --dev \
    && find /usr/local \
        \( -type d -a -name test -o -name tests \) \
        -o \( -type f -a -name '*.pyc' -o -name '*.pyo' \) \
        -exec rm -rf '{}' \+

ARG RUNTIME_DEPS="libcrypto3 libssl3 libpq"
RUN apk --no-cache add ${RUNTIME_DEPS}
RUN pip install gunicorn

WORKDIR /app
COPY . /app
COPY ./entrypoint.sh /home/entrypoint.sh
RUN chmod +x /home/entrypoint.sh
ENTRYPOINT [ "/home/entrypoint.sh" ]